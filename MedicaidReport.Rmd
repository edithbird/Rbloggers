---
title: "Medicaid Outpatient Narcotics"
output: html_notebook
---

This is an [Dataset](https://data.medicaid.gov/State-Drug-Utilization/State-Drug-Utilization-Data-2016/3v6v-qk5s) Notebook. When you execute code within the notebook, the results appear beneath the code. 

This is a [description of the dataset](file:///C:/Users/Chris%20Iyer/Downloads/Drug_Utilization_Data_Descriptions.pdf)

```{r}
library(knitr)
library(dplyr)
library(rvest)
library(ggplot2)
```

```{r}
medicaid <- read.csv("medicaid.csv", header = T, stringsAsFactors = F)
```





```{r}
Narcotics <- read_html("https://www.drugs.com/drug-class/narcotic-analgesics.html")
Drug_Names <- Narcotics %>% html_nodes("br+ .small a") %>% html_text()

```


```{r}
Medicaid <- as.data.frame(medicaid)
str(Medicaid)

kable(head(Medicaid))

```

```{r}

Drug_Names <- unique(toupper(Drug_Names))
Drugs <- c("MORPHINE",
"OXYMORPHONE", 
"HYDROMORPHONE", 
"BUPRENORPHINE", 
"TRAMADOL", 
"HYDROCODONE", 
"BUTORPHANOL",  
"PROPOXYPHENE", 
"LEVORPHANOL",
"TAPENTADOL",
"PENTAZOCINE",  
"REMIFENTANIL")

medicaid1 <- Medicaid %>% filter(Product.Name %in% Drug_Names)
dim(medicaid1)
unique(medicaid1$Product.Name)




```

```{r}
MORPHINE <- Medicaid %>% filter(grepl("MORPHINE", Product.Name))
OXYMORPHONE <- Medicaid %>% filter(grepl("OXYMORPHONE", Product.Name))
HYDROMORPHONE <- Medicaid %>% filter(grepl("HYDROMORPHONE", Product.Name))
BUPRENORPHINE <- Medicaid %>% filter(grepl("BUPRENORPHINE", Product.Name))
TRAMADOL <- Medicaid %>% filter(grepl("TRAMADOL", Product.Name))
HYDROCODONE <- Medicaid %>% filter(grepl("HYDROCODONE", Product.Name))
BUTORPHANOL  <- Medicaid %>% filter(grepl("BUTORPHANOL", Product.Name))
PROPOXYPHENE <- Medicaid %>% filter(grepl("PROPOXYPHENE", Product.Name))
LEVORPHANOL  <- Medicaid %>% filter(grepl("LEVORPHANOL", Product.Name)) 
TAPENTADOL <- Medicaid %>% filter(grepl("TAPENTADOL", Product.Name))
PENTAZOCINE <- Medicaid %>% filter(grepl("PENTAZOCINE", Product.Name))
REMIFENTANIL <- Medicaid %>% filter(grepl("REMIFENTANIL", Product.Name))
``` 

```{r}
allDrugs <- rbind.data.frame(medicaid1, MORPHINE, OXYMORPHONE, HYDROMORPHONE, BUPRENORPHINE, TRAMADOL, HYDROCODONE, BUTORPHANOL, PROPOXYPHENE, LEVORPHANOL, TAPENTADOL, PENTAZOCINE, REMIFENTANIL )
dim(allDrugs)
```

```{r}
dim(medicaid1)
dim(MORPHINE)
dim(OXYMORPHONE)
dim(HYDROMORPHONE)
dim(BUPRENORPHINE)
dim(TRAMADOL)
dim(HYDROCODONE)
dim(BUTORPHANOL)
dim(PROPOXYPHENE)
dim(LEVORPHANOL)
dim(TAPENTADOL)
dim(PENTAZOCINE)
dim(REMIFENTANIL)
```

All the Narcotics in All States

```{r}
dim(allDrugs)
head(allDrugs)
allDrugs <- allDrugs %>% arrange(desc(State))
head(allDrugs)

```
Total number of prescriptions

```{r}
allDrugs %>% 
  group_by(State) %>% 
  summarise(sumNumber = sum(Number.of.Prescriptions,na.rm=TRUE), sumAmount = sum(Medicaid.Amount.Reimbursed,na.rm=TRUE))
```

All Drugs with State XX removed

```{r}
noXX <- allDrugs %>% filter(State != "XX") %>% 
  group_by(State) %>% 
  summarise(sumNumber = sum(Number.of.Prescriptions,na.rm=TRUE), sumAmount = sum(Medicaid.Amount.Reimbursed,na.rm=TRUE))

```

XX

```{r}
XX <- allDrugs %>% filter(State == "XX") %>% 
  group_by(State) %>% 
  summarise(sumNumber = sum(Number.of.Prescriptions,na.rm=TRUE), sumAmount = sum(Medicaid.Amount.Reimbursed,na.rm=TRUE))
```


#what is XX?

```{r}
sum(noXX$sumNumber)/XX$sumNumber
sum(noXX$sumAmount)/XX$sumAmount
XX$sumNumber/sum(noXX$sumNumber)
XX$sumAmount/sum(noXX$sumAmount)
```

Quarterly number of prescriptions

```{r}
allDrugs %>% group_by(State, Quarter) %>% summarise(sumNumber = sum(Number.of.Prescriptions,na.rm=TRUE))
```

Quarterly Count of NA Values per state
We don't know the number of prescriptions for each NA value

```{r}
Subs1<-subset(allDrugs, (is.na(allDrugs[,11]))) 

Subs2 <- Subs1%>% group_by(State, Quarter) %>% summarise(count = n())

head(Subs2, 28)
```

Number of NA entries in the allDrugs dataset.

```{r}
MENoNA <- allDrugs %>% na.omit() 
dim(allDrugs)
dim(MENoNA)
28317/62034
```



Arkansas

```{r}

AK <- allDrugs %>% filter(State == "AK") 
dim(AK)
#There are 826 entries in AK
sum(is.na(AK$Number.of.Prescriptions))
summary(AK)
#Summary shows there are 480 NA entries
AKNoNA <- allDrugs %>% na.omit()  
head(AK)
#Percentage of values that are NA
480/826
```

Maine

```{r}
ME <- allDrugs %>% filter(State == "ME") 
dim(ME)
sum(is.na(ME$Number.of.Prescriptions))
summary(ME)
head(ME)
sumME
#Number of NA
293/688
```

CA

```{r}
CA <- allDrugs %>% filter(State == "CA") 
dim(CA)
sum(is.na(CA$Number.of.Prescriptions))
summary(CA)
head(CA)
#Number of NA
1275/2904
```


```{r, fig.height=25, fig.width=10}
ggplot(allDrugs, aes(x = (sum(is.na(Number.of.Prescriptions))/Number.of.Prescriptions), group = factor(State))) + geom_bar() + facet_wrap(~State, ncol = 3)
```


Visualization of missing values

```{r, fig.height=8, fig.width=10}
library(Amelia)
missmap(AK, main="Missing Data Map")
```

```{r}
head(allDrugs)
dim(allDrugs)
```




```{r}
library(reshape2)
library(ggplot2)
library(plyr)
allDrugsNoNA <- allDrugs %>% na.omit()
head(allDrugsNoNA)
dim(allDrugsNoNA)
allDrugsNoNA$z <- ave(allDrugsNoNA$Number.of.Prescriptions, allDrugsNoNA$State, FUN=scale)
head(allDrugsNoNA)

new_DF <- allDrugs[rowSums(is.na(allDrugs)) > 0,]
new_DF[new_DF=='NA'] <- NA
head(new_DF)


```




```{r}
ggplot(allDrugsNoNA, aes(x = z, fill = factor(State)))+  geom_bar(aes(y=..density..), position='stack', binwidth = 50) + ylab("Percentage") + facet_wrap(~ State, ncol = 3) + theme_bw() 

```


```{r, fig.height=25, fig.width=10}

ggplot(allDrugsNoNA, aes(x = Number.of.Prescriptions, fill = factor(State))) + geom_histogram(binwidth = 150) + facet_wrap(~ State, ncol = 3) +  theme_bw() 

 # ggplot(allDrugsNoNA, aes(x = Quarter)) + geom_density() + 
 #  facet_wrap(~State, ncol = 3)

#ggplot(allDrugsNoNA, aes(x=Number.of.Prescriptions)) + geom_freqpoly() + facet_wrap(~State)


```



```{r, fig.height=25, fig.width=10}
head(allDrugsNoNA)
ggplot(allDrugsNoNA, aes(x = Number.of.Prescriptions, group= factor(State))) + geom_histogram() + facet_wrap(~ State, ncol = 3) + theme_bw() +scale_x_continuous(c(0, 1000))
```

```{r}
x <- allDrugs %>% group_by(State) %>% summarise(variable = sum(is.na(Number.of.Prescriptions))/prod(dim(Number.of.Prescriptions))) %>% rename(state = State)
x

y <- allDrugs %>% group_by(State) %>% summarise(count = n())
y

z <- cbind(x,y)

z <- z %>% mutate(PercentNA = variable/count) %>% select(State, PercentNA)
z

```




```{r}
group_by(dataIn, replicate) %>% 
    summarise(ratio = quant[group=="case"]/quant[group=="controls"])
```

